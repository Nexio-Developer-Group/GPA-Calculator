<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>University Course Selection</title>
    <style>
        /* Style for scrollable container */
        #optional-subjects-container {
            max-height: 200px; /* Set the max height of the container */
            overflow-y: auto;  /* Enable vertical scrolling */
            margin-bottom: 20px; /* Add margin below the container */
            border: 1px solid #ccc; /* Optional: Add border for styling */
            padding: 10px; /* Optional: Add padding for better spacing */
        }

        /* Style for each optional subject checkbox container */
        #optional-subjects {
            display: flex;
            flex-direction: column;
        }

        #optional-subjects div {
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <h2>Select Department, Program, Minor, and Semester</h2>

    <!-- Dropdowns for Department, Program, and Minor Selection -->
    <label for="department">Select Department:</label>
    <select id="department" onchange="updatePrograms()">
        <option value="">-- Select Department --</option>
    </select>

    <br><br>

    <label for="program">Select Program:</label>
    <select id="program" onchange="updateMinors()" disabled>
        <option value="">-- Select Program --</option>
    </select>

    <br><br>

    <label for="minor">Select Minor:</label>
    <select id="minor" onchange="enableSemesterSelection()" disabled>
        <option value="">-- Select Minor --</option>
    </select>

    <br><br>

    <!-- Static Dropdown for Semester (1-8) -->
    <label for="semester">Select Semester:</label>
    <select id="semester" disabled onchange="fetchSubjects()">
        <option value="">-- Select Semester --</option>
        <option value="1">Semester 1</option>
        <option value="2">Semester 2</option>
        <option value="3">Semester 3</option>
        <option value="4">Semester 4</option>
        <option value="5">Semester 5</option>
        <option value="6">Semester 6</option>
        <option value="7">Semester 7</option>
        <option value="8">Semester 8</option>
    </select>

    <br><br>

    <!-- Subjects List -->
    <h3>Subjects & Grade Input</h3>
    <table border="1">
        <thead>
            <tr>
                <th>Subject</th>
                <th>Credits</th>
                <th>Grade</th>
            </tr>
        </thead>
        <tbody id="subject-table"></tbody>
    </table>

    <br>

    <!-- Scrollable Container for Optional Subjects -->
    <h3>Select Optional Subjects</h3>
    <div id="optional-subjects-container">
        <div id="optional-subjects">
            <!-- Dynamic checkbox options will be appended here -->
        </div>
    </div>
    <button onclick="addOptionalSubjects()">Apply</button>

    <h3>Optional Subjects & Grade Input</h3>
    <table border="1">
        <thead>
            <tr>
                <th>Subject</th>
                <th>Credits</th>
                <th>Grade</th>
            </tr>
        </thead>
        <tbody id="optional-subject-table"></tbody>
    </table>

    <br>
    <button onclick="calculateCGPA()">Calculate CGPA</button>
    <h3>CGPA: <span id="cgpa-result">-</span></h3>

    <script>
        let selectedDepartment = null;
        let selectedProgram = null;
        let selectedMinor = null;
        let selectedUBPMID = null;  // Store the UBPM ID
        let subjects = [];
        let optionalSubjects = [];
        let ubpmData = [];

        // Grade mapping for CGPA calculation
        const gradePointsMap = {
            "O": 10,
            "A+": 9,
            "A": 8,
            "B+": 7,
            "B": 6,
            "C": 5,
            "F": 0
        };

        // Fetch UBPM Data
        function fetchUBPM() {
            fetch('http://localhost:5000/api/ubpm')
                .then(response => response.json())
                .then(data => {
                    ubpmData = data;
                    populateDepartments();
                });
        }

        // Populate Departments Dropdown
        function populateDepartments() {
            const departmentDropdown = document.getElementById("department");
            const departments = [...new Set(ubpmData.map(item => item.department))];
            departments.forEach(department => {
                const option = document.createElement("option");
                option.value = department;
                option.textContent = department;
                departmentDropdown.appendChild(option);
            });
        }

        // Update Programs Dropdown based on selected Department
        function updatePrograms() {
            selectedDepartment = document.getElementById("department").value;
            const programDropdown = document.getElementById("program");
            programDropdown.innerHTML = "<option value=''>-- Select Program --</option>"; // Reset programs

            if (!selectedDepartment) {
                programDropdown.disabled = true;
                document.getElementById("minor").disabled = true;
                document.getElementById("semester").disabled = true;
                return;
            }

            programDropdown.disabled = false;
            const programs = ubpmData.filter(item => item.department === selectedDepartment);
            const programSet = [...new Set(programs.map(item => item.program))];
            
            programSet.forEach(program => {
                const option = document.createElement("option");
                option.value = program;
                option.textContent = program;
                programDropdown.appendChild(option);
            });
        }

        // Update Minors Dropdown based on selected Program
        function updateMinors() {
            selectedProgram = document.getElementById("program").value;
            const minorDropdown = document.getElementById("minor");
            minorDropdown.innerHTML = "<option value=''>-- Select Minor --</option>"; // Reset minors

            if (!selectedProgram) {
                minorDropdown.disabled = true;
                document.getElementById("semester").disabled = true;
                return;
            }

            minorDropdown.disabled = false;
            const minors = ubpmData.filter(item => item.program === selectedProgram).map(item => item.minor).filter(minor => minor);
            const uniqueMinors = [...new Set(minors)];

            uniqueMinors.forEach(minor => {
                const option = document.createElement("option");
                option.value = minor;
                option.textContent = minor;
                minorDropdown.appendChild(option);
            });
        }

        // Enable Semester Selection
        function enableSemesterSelection() {
            selectedMinor = document.getElementById("minor").value;
            const semesterDropdown = document.getElementById("semester");
            
            if (!selectedDepartment || !selectedProgram || !selectedMinor) {
                semesterDropdown.disabled = true;
                return;
            }

            // Get the UBPM ID based on the selected department, program, and minor
            selectedUBPMID = ubpmData.find(item => 
                item.department === selectedDepartment && 
                item.program === selectedProgram && 
                item.minor === selectedMinor
            )?.UBPM_ID;

            semesterDropdown.disabled = false;
        }

        // Fetch Subjects based on UBPM ID and Semester
        function fetchSubjects() {
            const semester = document.getElementById("semester").value;
            if (!selectedUBPMID || !semester) return;

            fetch(`http://localhost:5000/api/subjects/${selectedUBPMID}/${semester}`)
                .then(response => response.json())
                .then(data => {
                    subjects = data;
                    updateSubjectTable("subject-table", subjects);
                });
        }

        // Update Subject Table (For Regular or Optional Subjects)
        function updateSubjectTable(tableId, subjectList) {
            const table = document.getElementById(tableId);
            table.innerHTML = "";
            subjectList.forEach(subject => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${subject.subject_name}</td>
                    <td>${subject.subject_cred}</td>
                    <td><select class="grade-input">
                        <option value="">-- Select Grade --</option>
                        <option value="O">O (10)</option>
                        <option value="A+">A+ (9)</option>
                        <option value="A">A (8)</option>
                        <option value="B+">B+ (7)</option>
                        <option value="B">B (6)</option>
                        <option value="C">C (5)</option>
                        <option value="F">F (0)</option>
                    </select></td>
                `;
                table.appendChild(row);
            });
        }

        // Fetch Optional Subjects
        function fetchOptionalSubjects() {
            fetch('http://localhost:5000/api/opt-subjects')
                .then(response => response.json())
                .then(data => {
                    const optionalSubjectsDiv = document.getElementById("optional-subjects");
                    optionalSubjectsDiv.innerHTML = ""; // Clear previous checkboxes

                    data.forEach(subject => {
                        const label = document.createElement("label");
                        label.textContent = subject.subject_name;

                        const checkbox = document.createElement("input");
                        checkbox.type = "checkbox";
                        checkbox.value = JSON.stringify(subject);
                        checkbox.name = "optionalSubject";

                        const div = document.createElement("div");
                        div.appendChild(checkbox);
                        div.appendChild(label);
                        optionalSubjectsDiv.appendChild(div);
                    });
                });
        }

        // Add Selected Optional Subjects
        function addOptionalSubjects() {
            const checkboxes = document.querySelectorAll('input[name="optionalSubject"]:checked');
            
            // Clear previous optional subjects from the table before adding new ones
            optionalSubjects = [];

            // Collect selected optional subjects
            for (let i = 0; i < checkboxes.length; i++) {
                const subject = JSON.parse(checkboxes[i].value);
                optionalSubjects.push(subject);
            }
            updateSubjectTable("optional-subject-table", optionalSubjects);
        }

        // Calculate CGPA
        function calculateCGPA() {
            const gradeInputs = document.querySelectorAll(".grade-input");
            let totalPoints = 0;
            let totalCredits = 0;

            // Calculate for regular subjects
            subjects.forEach((subject, index) => {
                const grade = gradeInputs[index].value;
                if (grade) {
                    const gradePoints = gradePointsMap[grade.toUpperCase()] || 0;
                    totalPoints += gradePoints * subject.subject_cred;
                    totalCredits += subject.subject_cred;
                }
            });

            // Calculate for optional subjects
            optionalSubjects.forEach((subject, index) => {
                const grade = gradeInputs[subjects.length + index].value;
                if (grade) {
                    const gradePoints = gradePointsMap[grade.toUpperCase()] || 0;
                    totalPoints += gradePoints * subject.subject_cred;
                    totalCredits += subject.subject_cred;
                }
            });

            const cgpa = totalCredits ? (totalPoints / totalCredits).toFixed(2) : 0;
            document.getElementById("cgpa-result").textContent = cgpa;
        }

        // Initial Fetch
        fetchUBPM();
        fetchOptionalSubjects();
    </script>
</body>
</html>
